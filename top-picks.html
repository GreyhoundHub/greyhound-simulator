<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Top 3 Picks</title>
  <style>
    body { font-family: sans-serif; padding: 40px; background: #f8fafc; color: #111827; max-width: 700px; margin: auto; }
    h2 { font-size: 1.8em; color: #2563eb; }
    ul { padding-left: 20px; }
    li { margin: 8px 0; }
    .highlight { font-weight: bold; color: #059669; }
  </style>
</head>
<body>
  <h2>üêæ Top 3 Picks ‚Äì <span id="today"></span></h2>
  <ul id="top3"></ul>

  <script>
    document.getElementById("today").textContent = new Date().toLocaleDateString();
    const CSV_URL = "https://raw.githubusercontent.com/GreyhoundHub/greyhound-simulator/main/RACE_CARD.csv";

    function parseCSV(text) {
      const [headerLine, ...lines] = text.trim().split("\n");
      const headers = headerLine.split(",").map(h => h.trim());
      return lines.map(line => {
        const values = line.split(",");
        const row = {};
        headers.forEach((h, i) => row[h] = values[i]?.trim());
        row['RATED PRICE'] = parseFloat(row['RATED PRICE']);
        row['RUG'] = parseInt(row['RUG']);
        return row;
      });
    }

    function findTopPicks(data) {
      const grouped = {};
      data.forEach(dog => {
        const raceId = dog['RACE ID'];
        if (!grouped[raceId]) grouped[raceId] = [];
        grouped[raceId].push(dog);
      });

      let topPicks = [];
      let gap = 4.0;

      while (topPicks.length < 3 && gap >= 3.0) {
        topPicks = [];
        Object.values(grouped).forEach(race => {
          const sorted = race.filter(d => !isNaN(d['RATED PRICE'])).sort((a, b) => a['RATED PRICE'] - b['RATED PRICE']);
          if (sorted.length < 2) return;
          const fav = sorted[0];
          const second = sorted[1];
          const priceGap = second['RATED PRICE'] - fav['RATED PRICE'];
          const isEligibleRug = [1, 2, 8].includes(fav['RUG']);
          if (priceGap >= gap && isEligibleRug) {
            topPicks.push(fav);
          }
        });
        if (topPicks.length < 3) gap -= 0.5;
      }

      return topPicks.slice(0, 3);
    }

    fetch(CSV_URL)
      .then(res => res.text())
      .then(parseCSV)
      .then(findTopPicks)
      .then(top3 => {
        const ul = document.getElementById("top3");
        if (top3.length === 0) {
          ul.innerHTML = '<li>No suitable top picks found.</li>';
        } else {
          top3.forEach((dog, i) => {
            ul.innerHTML += `<li><span class="highlight">${i + 1}.</span> ${dog.TRACK} R${dog.RACE} ‚Äì ${dog.NAME} (Rated Price: $${dog['RATED PRICE'].toFixed(2)}, Rug: ${dog['RUG']})</li>`;
          });
        }
      })
      .catch(err => {
        document.getElementById("top3").innerHTML = `<li>Error loading tips: ${err.message}</li>`;
      });
  </script>
</body>
</html>
